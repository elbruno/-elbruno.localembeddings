# Plan: Multimodal Document Analysis RAG with Foundry Local

**Date:** 2026-02-16 14:45  
**Status:** Active  
**Goal:** Build a sample that combines PDF processing, image embeddings (CLIP), text embeddings, and a local Foundry LLM (phi-4-mini) to enable multimodal document analysis and retrieval-augmented generation.

---

## Overview

Create a **DocumentRagFoundry** sample application that:

- Processes 2 PDF documents (extracts text + converts pages to images)
- Indexes 2 additional images
- Uses `ElBruno.LocalEmbeddings` (text) + `ElBruno.LocalEmbeddings.ImageEmbeddings` (CLIP) for dual embeddings
- Retrieves relevant content (text AND images) based on user queries
- Uses **Foundry Local + phi-4-mini** model to generate intelligent answers

---

## Architecture

### Components

```
User Query
    ↓
Query Embedding (text) + Image Search (if needed)
    ↓
Retrieve Documents (text + relevant images)
    ↓
Foundry Local (phi-4-mini) - Generate Answer
    ↓
Response + Retrieved Context
```

### Key Libraries

1. **PDF Processing:** `PdfSharp` (MIT licensed, pure .NET, no external dependencies)
   - Extract text content
   - Convert pages to images (PDFium.NET or render via SkiaSharp)

2. **Embeddings:**
   - Text: `ElBruno.LocalEmbeddings` (existing)
   - Image: `ElBruno.LocalEmbeddings.ImageEmbeddings` (existing)

3. **Foundry Local Integration:** (Following `samples/RagFoundryLocal` approach)
   - `Microsoft.AI.Foundry.Local` — manage Foundry Local instance lifecycle via `FoundryLocalManager.StartModelAsync(modelAlias)`
   - `Microsoft.Extensions.AI.OpenAI` — OpenAI client adapter
   - Streaming responses via `chatClient.GetStreamingResponseAsync()`
   - Model alias resolution helper (`ResolveModelIdAsync`) to resolve phi-4-mini to actual model ID
   - Build prompts with retrieved context (text snippets + image paths)
   - API Key: obtained from `FoundryLocalManager`

4. **UI:** `Spectre.Console` (as used in `ImageRagChat`)

---

## Implementation Plan

### Phase 1: Project Setup

- [ ] Create `samples/DocumentRagFoundry/` directory
- [ ] Create `DocumentRagFoundry.csproj` with dependencies (follow `RagFoundryLocal` pattern):
  - `ElBruno.LocalEmbeddings` (text embeddings)
  - `ElBruno.LocalEmbeddings.ImageEmbeddings` (CLIP image embeddings)
  - `PdfSharp` (v6.x or latest, for PDF text extraction)
  - `PDFium.NET` OR `SkiaSharp` (for PDF page → image conversion)
  - `Microsoft.AI.Foundry.Local` (Foundry Local lifecycle management)
  - `Microsoft.Extensions.AI.OpenAI` (OpenAI client adapter)
  - `Spectre.Console` (interactive UI)

### Phase 2: PDF Processing Module

### Phase 2: PDF Processing Module

- [ ] Implement `PdfProcessor` class
  - `ExtractTextAsync(pdfPath)` → returns text content with page metadata
  - `ConvertPagesToImagesAsync(pdfPath)` → returns list of images (one per page)
  - Handle metadata (page numbers, source document name)

### Phase 3: Multimodal Indexing

- [ ] Create `MultimodalDocumentIndex` class
  - Index text segments with text embeddings
  - Index images with CLIP embeddings
  - Store metadata (source document, page number, type: text/image)
  - Track relationships between text and images from same document page

### Phase 4: Retrieval System

- [ ] Implement `MultimodalRetriever` class
  - Accept text query and generate query embedding
  - Retrieve top-K text results (using text embeddings)
  - Retrieve top-M images (using CLIP embeddings on query)
  - Combine results with deduplication

### Phase 5: Foundry Local Integration

- [ ] Follow `RagFoundryLocal` pattern:
  - [ ] Use `FoundryLocalManager.StartModelAsync("phi-4-mini")` to start the model
  - [ ] Create OpenAI client with manager's endpoint and API key
  - [ ] Implement `ResolveModelIdAsync(endpoint, alias)` helper to resolve alias
  - [ ] Implement `DocumentQaGenerator` class
    - Format retrieved context (text snippets + image paths) as system context
    - Build prompt with question and context
    - Stream response via `chatClient.GetStreamingResponseAsync()`
    - Return generated answer and usage stats

### Phase 6: User Interface & Main Loop

- [ ] Build interactive CLI (Spectre.Console)
  - Initialize Foundry Local manager at startup
  - Load and index documents on startup
  - Show available documents
  - Accept user queries in loop
  - Display retrieved content (text snippets with source + image paths)
  - Show streaming LLM-generated answer
  - Support `exit` command to shutdown

### Phase 7: Documentation & Examples

- [ ] Create `samples/DocumentRagFoundry/README.md`
  - Setup instructions (PDFs and images are in `samples/docs/`)
  - Prerequisites (Foundry Local running, phi-4-mini available)
  - Usage examples with sample queries
  - Configuration guide (data path: `../docs/`)
- [ ] Add entry to `samples/README_IMAGES.md` table and running instructions
- [ ] Document in `docs/` if needed

---

## Input Data Structure

```
samples/
├── docs/
│   ├── document1.pdf          (User provided)
│   ├── document2.pdf          (User provided)
│   ├── image1.jpg             (User provided)
│   └── image2.jpg             (User provided)
└── DocumentRagFoundry/
    ├── Program.cs
    ├── DocumentRagFoundry.csproj
    ├── Services/
    │   ├── PdfProcessor.cs
    │   ├── MultimodalDocumentIndex.cs
    │   └── DocumentQaGenerator.cs
    └── README.md
```

---

## Code Pattern (from RagFoundryLocal)

```csharp
// Start Foundry Local with model alias
await using var manager = await FoundryLocalManager.StartModelAsync("phi-4-mini");

// Resolve alias to actual model ID
var modelId = await ResolveModelIdAsync(manager.Endpoint, "phi-4-mini");

// Create OpenAI client with manager's credentials
var openAiClient = new OpenAIClient(
    new ApiKeyCredential(manager.ApiKey),
    new OpenAIClientOptions { Endpoint = manager.Endpoint });
IChatClient chatClient = openAiClient.GetChatClient(modelId).AsIChatClient();

// Build prompt with context
var prompt = BuildPrompt(userQuestion, retrievedContext);

// Stream response
await foreach (var update in chatClient.GetStreamingResponseAsync(
    [new ChatMessage(ChatRole.User, prompt)]))
{
    Console.Write(update.Text);
}
```

---

## Key Decisions

1. **Foundry Local Management:** Follow `RagFoundryLocal` for consistency
   - Automatic model startup via `FoundryLocalManager`
   - Model alias resolution for robustness
   - Streaming responses for better UX

2. **PDF Library:** `PdfSharp` chosen for:
   - Pure .NET, no external dependencies
   - MIT licensed
   - Works cross-platform
   - For image conversion: may need SkiaSharp or PDFium.NET

3. **Search Strategy:** Hybrid retrieval
   - Text query → retrieve text snippets + relevant images based on semantic similarity
   - Include source/page metadata in results

4. **LLM Prompt Design:**
   - System context: retrieved text snippets (with source/page info)
   - User query: original question
   - Ask phi-4-mini to answer using context and mention sources
   - Image paths included for user reference

5. **Error Handling:**
   - Graceful shutdown if Foundry Local unreachable
   - Handle missing PDF content/images gracefully
   - Validate retrieval results

---

## Expected Outputs

1. **New Sample Project:** `samples/DocumentRagFoundry/`
2. **Reusable Service Classes:**
   - `PdfProcessor` (extract text + convert pages to images)
   - `MultimodalDocumentIndex` (store + retrieve embeddings)
   - `DocumentQaGenerator` (format context + call LLM)
3. **Documentation:**
   - New sample entry in `samples/README_IMAGES.md`
   - Full README in sample folder
4. **Example Interactions:** Show text queries and LLM responses

---

## Success Criteria

- ✅ Application successfully indexes 2 PDFs + 2 images
- ✅ User can query documents and receive relevant text + image results with sources
- ✅ Foundry Local phi-4-mini streams coherent answers using retrieved context
- ✅ UI is intuitive with clear formatting (Spectre.Console)
- ✅ Code mirrors `RagFoundryLocal` patterns for consistency
- ✅ README provides clear setup and usage instructions

---

## Timeline Estimate

- Phase 1 (Setup): 15 min
- Phase 2 (PDF processing): 45 min
- Phase 3 (Indexing): 1 hour
- Phase 4 (Retrieval): 45 min
- Phase 5 (Foundry integration): 1 hour
- Phase 6 (UI): 1.5 hours
- Phase 7 (Docs): 45 min

**Total: ~6-7 hours**

---

## Dependencies on User

- [ ] Provide 2 sample PDFs in `samples/docs/` (document1.pdf, document2.pdf)
- [ ] Provide 2 sample images in `samples/docs/` (image1.jpg, image2.jpg)
- [ ] Foundry Local instance running with phi-4-mini available
